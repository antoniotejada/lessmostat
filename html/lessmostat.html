<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- based on https://codepen.io/simoberny/pen/wrGoZZ-->

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="lessmostat.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/paho-mqtt.js" type="text/javascript"></script>
    <!-- from https://thenounproject.com/term/thermostat/614999/ -->
    <link rel="icon" type="image/svg+xml" href="lessmostat.svg">
<script type = "text/javascript" language = "javascript">
'use strict';
var mqtt;
var host="192.168.8.200";
var port=9001;

var targetDeg = 35;
var currentDeg = 30;
var currentHumid = 44;
var currentAcState = "unknown";
var displayCelsius = true;
var targetFanState = "auto";
var currentFanState = "unknown";
var acUptime = 0;
var acLastModTime = 0;
var startTime = 0;

var topic_root = "apartment/lessmostat/"

function onMessageArrived(message) {
    console.log("onMessageArrived: topic " + message.destinationName + " msg " + message.payloadString);
    var topic = message.destinationName;
    if (topic == topic_root + "info/sensor") {
        // Animate on every sensor message to signal there's a connection
        // XXX This should be done in a different way since the sensor may switch
        //     to send only deltas
        $(".units").fadeOut(1000, function() {
            $(".units").fadeIn(1000);
        });
        var data = JSON.parse(message.payloadString);
        currentDeg = data.temp;
        currentHumid = data.humid;
        updateGr();

    } else if (topic == topic_root + "info/state") {
        var data = JSON.parse(message.payloadString);
        // XXX This asssumes a lot about the rules
        var ac_rules = data.state.config.ac_rules;
        var ac_on_rule = ac_rules[0].state == "on" ? ac_rules[0] : ac_rules[1];
        var fan_rules = data.state.config.fan_rules;
        var fan_on_rule = fan_rules[0];

        targetDeg = ac_on_rule.temp;
        currentAcState = data.state.ac;
        currentDeg = data.state.sensor.temp;
        currentHumid = data.state.sensor.humid;
        targetFanState = fan_on_rule.state; 
        currentFanState = data.state.fan;
        startTime = data.state.start_ts;
        acUptime = data.state.ac_uptime;
        acLastModTime = data.state.ac_mod_ts;
        updateGr();

    } else if (topic == topic_root + "info/ac") {
        var data = JSON.parse(message.payloadString);
        currentAcState = data.state;
        acLastModTime = data.mod_ts;
        acUptime = data.uptime;
        updateGr();
    } else if (topic == topic_root + "info/fan") {
        var data = JSON.parse(message.payloadString);
        currentFanState = data.state;
        updateGr();
    }
};	

function timestamp_message(msg) {
    msg.ts = Math.round((new Date()).getTime() / 1000); 
    return msg;
}

function requestTargetDeg(newTargetDeg) {
    var msg = timestamp_message({ 
        state : "on", 
        temp : newTargetDeg 
    });
    var message = new Paho.Message(JSON.stringify(msg));
    message.destinationName = topic_root + "control/ac";
    mqtt.send(message);
}

function requestFanToggle() {
    var requestedFanState = "on";
    if (targetFanState == "on") {
        requestedFanState = "auto";
    }
    var msg = timestamp_message({
        state : requestedFanState, 
    });
    var message = new Paho.Message(JSON.stringify(msg));
    message.destinationName = topic_root + "control/fan";
    mqtt.send(message);
}

function onConnect() {
    // Once a connection has been made, make a subscription and send a message.
    console.log("Connected ");
    mqtt.subscribe(topic_root + "#");
    var msg = timestamp_message({});
    var message = new Paho.Message(JSON.stringify(msg));
    message.destinationName = topic_root + "control/state";
    mqtt.send(message);
}

function onConnectionLost(responseObject) {
    if (responseObject.errorCode !== 0) {
        console.log("onConnectionLost:" + responseObject.errorMessage);
    }
};

function onConnected() {
    console.log("Connected");
}

function onFailure() {
    console.log("onFailure");
}

function MQTTconnect() {
    var x = Math.floor(Math.random() * 10000); 
    var cname = "lessmostat-"+x;
    console.log("connecting " + cname + " to " + host + " " + port);
    mqtt = new Paho.Client(host, port, cname);
    var options = {
        timeout: 3,
        onSuccess: onConnect,
        onFailure: onFailure,
        reconnect: true,
    };
    mqtt.onConnected = onConnected;
    mqtt.onConnectionLost = onConnectionLost;
    mqtt.onMessageArrived = onMessageArrived;
    
    mqtt.connect(options);
}


// circular degrees blocked by the status label
var degreesUnused = 40;
// Celsius for 0+degreesUnused/2 and 360-degreesUnused/2 circular degrees
var maxDeg = 40;
var minDeg = 10;

function degToDegrees(deg) {
    var offsetDeg = deg - minDeg;    
    var degreesPerDeg = (360.0 - degreesUnused) / (maxDeg - minDeg);
    
    return -180 + degreesUnused/2.0 + offsetDeg * degreesPerDeg;
}

function roundDecimals(f, numDecimals) {
    var magnitude = Math.pow(10, numDecimals);
    return (Math.round(f * 1.0 * magnitude) / magnitude);
}

function updateGr() {
    
    var currentDegDisplay = currentDeg;
    var targetDegDisplay = targetDeg;
    var currentHumidDisplay = currentHumid;

    // Fahrenheit / Celsius
    var unitChar = '\u2103';
    if (!displayCelsius) {
        currentDegDisplay = currentDeg * 9.0 / 5.0 + 32.0;
        targetDegDisplay = targetDeg * 9.0 / 5.0 + 32.0;
        unitChar = '\u2109';
    }
    // Round to one decimal
    currentDegDisplay = roundDecimals(currentDegDisplay, 1);
    targetDegDisplay = roundDecimals(targetDegDisplay, 1);
    currentHumidDisplay = roundDecimals(currentHumidDisplay, 1);

    var now = (new Date()).getTime() / 1000;
    var acUtilization = acUptime;
    if (currentAcState == "on") {
        // If AC is running, accumulate the last running time since uptime
        // doesn't include it until AC is turned off
        acUtilization += (now - acLastModTime);
    }
    acUtilization = (acUtilization * 100.0) / (now - startTime);
    var acUtilizationDisplay = roundDecimals(acUtilization, 1);

    $(".heat").text("" + currentDegDisplay);
    $(".units").text("" + '\uD83C\uDF21' + unitChar  + ' \u2746 ' + acUtilizationDisplay + "%");
    $(".humid").text('\uD83D\uDCA7' + currentHumidDisplay + "%");
    $(".ext").text("" + targetDegDisplay);
    $(".number").css("transform", "translate(-50%, -50%) rotate("+ degToDegrees(targetDeg)+"deg)");
    $(".shadow").css("transform", "translate(-50%, -50%) rotate("+ degToDegrees(targetDeg)+"deg)");
    $(".fill").css("animation", "none");
    $(".fill1").css("transform", "rotate("+ (Math.max(degToDegrees(currentDeg), 0)) +"deg)");
    $(".fill2").css("transform", "rotate("+ (Math.min(degToDegrees(currentDeg), 1) - 180) +"deg)");
    $(".shadow").css("animation", "none");
    if (currentAcState == "on") {
        $(".cooling").text("cooling");
        $(".cooling").css("color", "cyan");
    } else {
        $(".cooling").text("idle");
        $(".cooling").css("color", "#2e2c3a")
    }
    if (targetFanState == "on") {
        $(".fan").text("" + '\u2622' + " on");
    } else {
        $(".fan").text("" + '\u2622' + " auto");
    }
    if (currentFanState == "on") {
        $(".fan").css("color", "black");
    } else {
        $(".fan").css("color", "gray");
    }
}


$(document).ready(function(){
    updateGr();
    MQTTconnect();

    $(".minus").mousedown(function(){ 
        if (targetDeg > minDeg){
            // Don't update the local targetDeg until we receive the
            // confirmation from the server, this prevents the case where we
            // would locally update targetDeg multiple times, then receiving the
            // updates and updating the local targetDeg to some stale value
            requestTargetDeg(targetDeg - 1);
        }
    });

    $(".plus").mousedown(function(){
        if (targetDeg < maxDeg){
            // Don't update the local targetDeg until we receive the
            // confirmation from the server, this prevents the case where we
            // would locally update targetDeg multiple times, then receiving the
            // updates and updating the local targetDeg to some stale value
            requestTargetDeg(targetDeg + 1);
        }  
    });
    
    $(".heat").mousedown(function() {
        displayCelsius = !displayCelsius;
        updateGr();
    });
    $(".fan").mousedown(function() {
        requestFanToggle();
    });
});

</script>
</head>
<body>
<div class="thermostat">
  <div class="bar">
    <div class="inner_bar"></div>
    <div class='hold left'>
      <div class='fill fill1'></div>
    </div>
    <div class='hold right'>
      <div class='fill fill2'></div>
    </div>
    <span class="cooling">Cooling</span>
  </div>
  <div class="shadow">
    <div class="shadow-cube"></div>
  </div>
  <div class="number">
    <span class="ext">19</span>
  </div>
  <div class="center">
    <span class="arrow minus"><i class="material-icons">keyboard_arrow_left</i></span>
    <span class="arrow plus"><i class="material-icons">keyboard_arrow_right</i></span>
    <div class="small">
        <span class="heat">19</span>
        <span class="units">&#8451;</span>
        <span class="humid">44%</span>
        <span class="fan">&#9762; auto</span>
    </div>
  </div>
</div>
</body>
</html>