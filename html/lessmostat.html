<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<!-- https://codepen.io/simoberny/pen/wrGoZZ-->

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="lessmostat.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.js" type="text/javascript"></script>
<script type = "text/javascript" language = "javascript">

var mqtt;
var reconnectTimeout = 2000;
var host="192.168.8.200";
var port=9001;

var targetDeg = 35;
var currentDeg = 30;
var currentHumid = 44;
var currentAcState = "unknown";
var displayCelsius = true;

var topic_root = "apartment/lessmostat/"

function onMessageArrived(message) {
    console.log("onMessageArrived: topic " + message.destinationName + " msg " + message.payloadString);
    var topic = message.destinationName;
    if (topic == topic_root + "info/sensor") {
        // Animate on every sensor message to signal there's a connection
        // XXX This should be done in a different way since the sensor may switch
        //     to send only deltas
        $(".units").fadeOut(1000, function() {
            $(".units").fadeIn(1000)
        });
        data = JSON.parse(message.payloadString);
        currentDeg = data.temp;
        currentHumid = data.humid;
        updateGr();

    } else if (topic == topic_root + "info/state") {
        data = JSON.parse(message.payloadString);
        // XXX This asssumes a lot about the rules
        ac_rules = data.state.config.ac_rules;
        ac_on_rule = ac_rules[0].state == "on" ? ac_rules[0] : ac_rules[1];
        targetDeg = ac_on_rule.temp;
        // XXX Note this is not necessary and may be weird if the message was
        //     caused by this client
        currentAcState = data.state.ac;
        currentDeg = data.state.sensor.temp;
        currentHumid = data.state.sensor.humid;
        updateGr();

    } else if (topic == topic_root + "info/ac") {
        data = JSON.parse(message.payloadString);
        currentAcState = data.state;
        updateGr();
    }
};	

function requestTargetDeg(newTargetDeg) {
    message = new Paho.MQTT.Message(JSON.stringify({ 
        ts: Math.round((new Date()).getTime() / 1000),  
        state : "on", 
        temp : newTargetDeg 
    }));
    message.destinationName = topic_root + "control/ac";
    mqtt.send(message);
}

function onConnect() {
    // Once a connection has been made, make a subscription and send a message.

    console.log("Connected ");
    mqtt.subscribe(topic_root + "#");
    message = new Paho.MQTT.Message("{ \"cmd\" : \"test\" }");
    message.destinationName = topic_root + "control/state";
    mqtt.send(message);
}

function MQTTconnect() {
    console.log("connecting to "+ host +" "+ port);
    var x=Math.floor(Math.random() * 10000); 
    var cname="orderform-"+x;
    mqtt = new Paho.MQTT.Client(host,port,cname);
    //document.write("connecting to "+ host);
    var options = {
        timeout: 3,
        onSuccess: onConnect,
    };
    //mqtt.onConnectionLost = onConnectionLost;
    //mqtt.onConnected = onConnected;
    mqtt.onMessageArrived = onMessageArrived;

    mqtt.connect(options); //connect
}


var maxDeg = 40;
var minDeg = 10;

function degToDegrees(deg) {
    var offsetDeg = deg - minDeg;
    var degreesUnused = 40;
    var degreesPerDeg = (360.0 - degreesUnused) / (maxDeg - minDeg);
    
    return -180 + degreesUnused/2.0 + offsetDeg * degreesPerDeg;
}

function updateGr() {
    
    var currentDegDisplay = currentDeg;
    var targetDegDisplay = targetDeg;

    // Fahrenheit / Celsius
    var unitChar = '\u2103';
    if (!displayCelsius) {
        currentDegDisplay = currentDeg * 9.0 / 5.0 + 32.0;
        targetDegDisplay = targetDeg * 9.0 / 5.0 + 32.0;
        unitChar = '\u2109';
    }
    // Round to one decimal
    currentDegDisplay = Math.round(currentDegDisplay * 10) / 10;
    targetDegDisplay = Math.round(targetDegDisplay * 10) / 10

    $(".heat").text("" + currentDegDisplay);
    $(".units").text("" + '\uD83C\uDF21' + unitChar);
    $(".humid").text('\uD83D\uDCA7' + currentHumid + "%");
    $(".ext").text("" + targetDegDisplay);
    $(".number").css("transform", "translate(-50%, -50%) rotate("+ degToDegrees(targetDeg)+"deg)");
    $(".shadow").css("transform", "translate(-50%, -50%) rotate("+ degToDegrees(targetDeg)+"deg)");
    $(".fill").css("animation", "none");
    $(".fill1").css("transform", "rotate("+ (Math.max(degToDegrees(currentDeg), 0)) +"deg)");
    $(".fill2").css("transform", "rotate("+ (Math.min(degToDegrees(currentDeg), 1) - 180) +"deg)");
    $(".shadow").css("animation", "none");
    if (currentAcState == "on") {
        $(".cooling").text("cooling");
        $(".cooling").css("color", "cyan");
    } else {
        $(".cooling").text("idle");
        $(".cooling").css("color", "#2e2c3a")
    }
}


$(document).ready(function(){
    updateGr();
    MQTTconnect();

    $(".minus").mousedown(function(){ 
        if (targetDeg > minDeg){
            // Don't update the local targetDeg until we receive the
            // confirmation from the server, this prevents the case where we
            // would locally update targetDeg multiple times, then receiving the
            // updates and updating the local targetDeg to some stale value
            requestTargetDeg(targetDeg - 1);
        }
    });

    $(".plus").mousedown(function(){
        if (targetDeg < maxDeg){
            // Don't update the local targetDeg until we receive the
            // confirmation from the server, this prevents the case where we
            // would locally update targetDeg multiple times, then receiving the
            // updates and updating the local targetDeg to some stale value
            requestTargetDeg(targetDeg + 1);
        }  
    });
    
    $(".heat").mousedown(function() {
        displayCelsius = !displayCelsius;
        updateGr();
    });
});

</script>
</head>
<body>
<div class="thermostat">
  <div class="bar">
    <div class="inner_bar"></div>
    <div class='hold left'>
      <div class='fill fill1'></div>
    </div>
    <div class='hold right'>
      <div class='fill fill2'></div>
    </div>
    <span class="cooling">Cooling</span>
  </div>
  <div class="shadow">
    <div class="shadow-cube"></div>
  </div>
  <div class="number">
    <span class="ext">19</span>
  </div>
  <div class="center">
    <span class="arrow minus"><i class="material-icons">keyboard_arrow_left</i></span>
    <span class="arrow plus"><i class="material-icons">keyboard_arrow_right</i></span>
    <div class="small">
        <span class="heat">19</span>
        <span class="units">&#8451;</span>
        <span class="humid">44%</span>
    </div>
  </div>
</div>
</body>
</html>